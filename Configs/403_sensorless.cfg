#############################################################################################################
# BEACON PROBE SENSORLESS HOMING MACROS 
#############################################################################################################

[gcode_macro _HOME_PRE_AXIS]
gcode:
  # Adapt this for your printer.
  {% set HOME_CURRENT = 0.7 %}
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

[gcode_macro _HOME_POST_AXIS]
gcode:
  {% set axis = params.AXIS %}
  {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
  {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}

  # Move away
  SAVE_GCODE_STATE NAME=home_post_axis
  G91
  {% if axis == "X" %}
    # X homes at ~-4 mm, move positive toward bed
    G0 X+10 F3600
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
  {% elif axis == "Y" %}
    # Y homes at ~300 mm, move negative toward bed
    G0 Y-10 F3600
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
  {% endif %}
  RESTORE_GCODE_STATE NAME=home_post_axis

  # Make sure StallGuard registers are cleared
  M400
  # Set current during print
  SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
  SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

[tmc2209 stepper_x]
driver_SGTHRS: 88										# 255 is most sensitive value, 0 is least sensitive		

[tmc2209 stepper_y]
driver_SGTHRS: 98								        # 255 is most sensitive value, 0 is least sensitive	

#############################################################################################################
# TAP SENSORLESS HOMING MACROS 
#############################################################################################################

#[homing_override]
#set_position_z: 0
#axes: xyz
#gcode:                                         
#
#  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
#
#  {% if home_all or 'X' in params %}
#    _HOME_X
#  {% endif %}
# 
#  {% if home_all or 'Y' in params %}
#    _HOME_Y
#  {% endif %}
#  
#  {% if home_all or 'Z' in params %}
#    BED_MESH_CLEAR
#    G0 X144 Y-145.5 F8400                                # reset to center bed // use real gantry size! // X150 = -4 +10 -144 // Y150 = 305.5 -10 -145.5
#    G28 Z
#    G1 Z10
#  {% endif %}


#[tmc2209 stepper_x]
#driver_SGTHRS: 88										# 255 is most sensitive value, 0 is least sensitive		


#[tmc2209 stepper_y]
#driver_SGTHRS: 98								        # 255 is most sensitive value, 0 is least sensitive	


#############################################################################################################
# TAP SENSORLESS HOMING MACROS 
#############################################################################################################

#[gcode_macro _HOME_X]
#gcode:
#    # Always use consistent run_current on A/B steppers during sensorless homing
#     {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
#     {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
#     {% set HOME_CURRENT = 0.7 %}
#     SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
#     SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Lift Z a bit    
#      G90                      # Absolute Mode
#      G1 Z3 F600              
    # Home
#     G28 X
    # Move away
#      G91
#      G1 X10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
#      G4 P2000
    # Set current during print
#      SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
#      SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#[gcode_macro _HOME_Y]
#gcode:
#    # Set current for sensorless homing
#     {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
#     {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
#     {% set HOME_CURRENT = 0.7 %}
#     SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
#     SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}

    # Home
#     G28 Y
    # Move away
#     G91
#     G1 Y-10 F1200

    # Wait just a second… (give StallGuard registers time to clear)
#      G4 P2000
    # Set current during print
#      SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
#     SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}